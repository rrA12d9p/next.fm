<%= form_tag("/search", method: "get") do %>
  <%= search_field(:q, '', placeholder: 'Track Name', autofocus: true) %>
  <%= submit_tag("Search") %>
<% end %>

	<ul class="results-list"></ul>

<script>
	var trackPlaying;

	$('form').on('submit', function(event){
		event.preventDefault();
		$('.results-list').empty();

		var searchInput = $("#q");
		var query = searchInput.val();
		searchInput.val("");
		
		SC.get('/tracks', { q: query }, function(tracks) {
		  _.each(tracks, function(track, i){
		  	if (track["policy"] != "ALLOW") { return false; }
		  	// console.log(track);

		  	var id = track["id"]
		  	var title = track["title"];
		  	var artwork_url = track["artwork_url"];
		  	var user = track["user"];

		  	var artwork = $('<img>').attr('src', artwork_url);

		  	var result = $('<li></li>').attr('id', 'result-' + (i + 1));
		  	var trackContainer = $('<div></div>').attr('id', id).addClass('trackContainer').appendTo(result);

		  	trackContainer.append($('<p></p>').html(artwork));
		  	trackContainer.append($('<p></p>').html(title));
		  	trackContainer.append($('<p></p>').html(user["username"]).attr('id', user["id"]));
		  	trackContainer.append($('<button type="button">Play</button>').addClass('play paused'));

		  	$('.results-list').append(result);
		  });

		  $('.play').on('click', function(){
		  	var playButton = $(this);

		  	if (playButton.hasClass('playing')) {
		  		playButton.removeClass('playing').addClass('paused').html('Play');
		  		trackPlaying.pause();
		  		return false;
		  	}

		  	var trackContainer = $(this).closest('.trackContainer');
		  	var id = trackContainer.attr('id');
		  	
		  	SC.stream("/tracks/" + id, function(sound){
		  		if (typeof trackPlaying != 'undefined') { trackPlaying.pause() };

  				sound.play({
	  		    onload: function() {
	  		      if (this.readyState == 2) {
								alert("this song is unstreamable due to some setting or something stupid. (TODO - better error handling)");
	  		      } else {
	  		      	console.log("streaming track " + id);
	  		      	trackPlaying = sound;

	  		      	playButton.removeClass('paused').addClass('playing').html('Pause');
	  		      }
	  		    }
  		    });
	  		}); // <- SC.stream

		  }); // <- onclick

	  }); // <- SC.get

	});
</script>

<script type="text/javascript">
	$(document).ready(function(){


	});
</script>